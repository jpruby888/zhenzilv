"use strict";var e=require("../../common/vendor.js");const n={__name:"login",setup(n){const a="../../static/images/defaultAvatar.png",t=e.ref(a),o=e.ref(""),s=async n=>{if(t.value===a||!n.detail.value.nickname)return e.index.showToast({title:"头像或者昵称不能为空",icon:"none"});const{success:s}=await c(t.value);if(!s)return e.index.showToast({title:"用户头像保存失败",icon:"none"});e.index.showLoading({title:"登录中...",mask:!0}),e.index.login().then((({code:a})=>{console.log("code",a),e.pn.callFunction({name:"zhenzilv",data:{api:"userlogin",code:a,avatar:t.value,nickname:n.detail.value.nickname}}).then((n=>{e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success"}),console.log("拿到用户信息为：",n.result),e.index.setStorageSync("user",JSON.stringify(n.result.user)),e.index.setStorageSync("token",n.result.token),e.index.navigateBack()})).catch((n=>{e.index.hideLoading(),e.index.showToast({title:"登录失败"}),console.log("获取用户信息失败",n)}))})).catch((e=>{console.log(e)})),o.value=null},i=()=>{console.log("reset")},l=e=>{const{avatarUrl:n}=e.detail;t.value=n},c=async n=>new Promise(((a,o)=>{let s=n.substring(n.lastIndexOf("/")+1,n.length),i=s.substring(s.lastIndexOf(".")+1,s.length);console.log("avatarProfile: ",i);const l=`userAvatar/${Date.now()}.${s}`;e.index.showLoading({title:"头像上传中"}),e.pn.uploadFile({filePath:n,cloudPath:l}).then((n=>{e.index.hideLoading(),n.success&&(e.index.showToast({title:"头像上传成功"}),t.value=n.fileID,a({success:!0}))})).catch((e=>{console.log("err: ",e),o({success:!1})}))}));return(n,a)=>({a:t.value,b:e.o(l),c:o.value,d:e.o((e=>o.value=e.detail.value)),e:e.o(s),f:e.o(i)})}};var a=e._export_sfc(n,[["__scopeId","data-v-4d0187d0"]]);wx.createPage(a);
